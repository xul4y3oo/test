// 1. è¨­å®šå€
const CHANNEL_ACCESS_TOKEN = 'æ‚¨çš„ Channel Access Token è²¼é€™è£¡';
// é€™è£¡å¡«æ‚¨çš„ç¶²ç«™é¦–é  (æœ€å¾Œä¸€å¼µå¡ç‰‡æœƒé€£éå»)
const WEBSITE_ALL_CAMPS_URL = 'https://www.google.com'; 

function doPost(e) {
  const msg = JSON.parse(e.postData.contents);
  const replyToken = msg.events[0].replyToken;
  const userMessage = msg.events[0].message.text;

  if (userMessage.includes("æŸ¥è©¢") || userMessage.includes("ç‡ŸéšŠ")) {
    sendShowcaseFlexMessage(replyToken);
  } else {
    replyText(replyToken, "è«‹è¼¸å…¥ã€ŒæŸ¥è©¢ã€ä¾†çœ‹çœ‹æ¸¬è©¦æ•ˆæœï¼");
  }
  return ContentService.createTextOutput(JSON.stringify({content: "post ok"})).setMimeType(ContentService.MimeType.JSON);
}

function sendShowcaseFlexMessage(replyToken) {
  // ã€æ¸¬è©¦æ¨¡å¼ã€‘ä¸é€£ç¶²ï¼Œç›´æ¥ç”¨æ‰‹å¯«çš„å‡è³‡æ–™æ¨¡æ“¬ç¶²ç«™å›å‚³
  // å‡è¨­é€™æ˜¯ç¶²ç«™å›å‚³çš„å‰ 3 ç­†ç†±é–€ç‡ŸéšŠ
  const topCamps = [
    {
      "name": "2024 æœªä¾†ç§‘æŠ€å¤ä»¤ç‡Ÿ",
      "price": "$5,000",
      "link": "https://google.com",
      "image": "https://images.unsplash.com/photo-1518770660439-4636190af475?w=500"
    },
    {
      "name": "å°å°è·äººé«”é©—ç‡Ÿ",
      "price": "$3,500",
      "link": "https://google.com",
      "image": "https://images.unsplash.com/photo-1515488042361-25f4682ae2ed?w=500"
    },
    {
      "name": "æˆ¶å¤–æ¢éšªæ±‚ç”Ÿç‡Ÿ",
      "price": "$8,800",
      "link": "https://google.com",
      "image": "https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?w=500"
    }
  ];

  // --- ä»¥ä¸‹é‚è¼¯éƒ½ä¸ç”¨å‹• ---

  // 1. è£½ä½œç‡ŸéšŠå¡ç‰‡
  const bubbles = topCamps.map(camp => {
    return {
      "type": "bubble",
      "hero": { 
        "type": "image", 
        "url": camp.image, 
        "size": "full", "aspectRatio": "20:13", "aspectMode": "cover" 
      },
      "body": {
        "type": "box", "layout": "vertical",
        "contents": [
          { "type": "text", "text": camp.name, "weight": "bold", "size": "xl", "wrap": true },
          { "type": "text", "text": "ğŸ”¥ ç†±é–€æ¨è–¦", "size": "xs", "color": "#ff5555", "margin": "md" },
          { "type": "text", "text": "ğŸ’° " + camp.price, "size": "sm", "color": "#666666", "margin": "sm" }
        ]
      },
      "footer": {
        "type": "box", "layout": "vertical",
        "contents": [
          { "type": "button", "action": { "type": "uri", "label": "æŸ¥çœ‹è©³æƒ…", "uri": camp.link }, "style": "primary" }
        ]
      }
    };
  });

  // 2. ã€é—œéµã€‘è£½ä½œæœ€å¾Œä¸€å¼µã€ŒæŸ¥çœ‹æ›´å¤šã€å¡ç‰‡
  const seeMoreCard = {
    "type": "bubble",
    "body": {
      "type": "box", "layout": "vertical", "spacing": "sm", "justifyContent": "center", "height": "100%",
      "contents": [
        { "type": "text", "text": "é‚„æ²’çœ‹åˆ°å–œæ­¡çš„ï¼Ÿ", "weight": "bold", "size": "xl", "align": "center", "wrap": true },
        { "type": "text", "text": "é»æ“Šä¸‹æ–¹æŒ‰éˆ•\nå‰å¾€å®˜ç¶²æœå°‹æ›´å¤šï¼", "size": "md", "color": "#666666", "align": "center", "wrap": true, "margin": "lg" }
      ]
    },
    "footer": {
      "type": "box", "layout": "vertical",
      "contents": [
        { 
          "type": "button", 
          "style": "secondary",
          "height": "sm",
          "action": { "type": "uri", "label": "å‰å¾€å®˜ç¶² âœ", "uri": WEBSITE_ALL_CAMPS_URL } 
        }
      ]
    },
    "styles": { "body": { "backgroundColor": "#f0f0f0" } }
  };

  // åŠ å…¥åˆ—è¡¨
  bubbles.push(seeMoreCard);

  const url = 'https://api.line.me/v2/bot/message/reply';
  const payload = {
    'replyToken': replyToken,
    'messages': [{
      "type": "flex",
      "altText": "ç²¾é¸ç‡ŸéšŠæ¨è–¦",
      "contents": { "type": "carousel", "contents": bubbles }
    }]
  };
  
  UrlFetchApp.fetch(url, {
    'headers': {
      'Content-Type': 'application/json; charset=UTF-8',
      'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN,
    },
    'method': 'post',
    'payload': JSON.stringify(payload),
  });
}

function replyText(replyToken, text) {
  UrlFetchApp.fetch('https://api.line.me/v2/bot/message/reply', {
    'headers': { 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN, 'Content-Type': 'application/json' },
    'method': 'post',
    'payload': JSON.stringify({ 'replyToken': replyToken, 'messages': [{ 'type': 'text', 'text': text }] }),
  });
}
